<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Atajos Pro ‚ö°Ô∏è</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #1a202c; /* Fondo oscuro */
            color: #e2e8f0; /* Texto claro */
        }
        .gradient-bg {
            background-image: linear-gradient(to right top, #6b46c1, #805ad5, #9f67ea, #bb6bf5, #d66ffc);
        }
        .shortcut-card {
            background-color: #2d3748; /* Color de tarjeta m√°s oscuro */
            border-radius: 1rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            transition: transform 0.2s ease-in-out;
            display: flex; /* Usar flexbox */
            flex-direction: column; /* Apilar elementos verticalmente */
            justify-content: space-between; /* Espaciar contenido */
        }
        .shortcut-card:hover {
            transform: translateY(-5px);
        }
        .category-button {
            background-color: #4a5568;
            color: #e2e8f0;
            border-radius: 9999px; /* fully rounded */
            padding: 0.5rem 1.25rem;
            transition: background-color 0.2s ease-in-out;
        }
        .category-button.active, .category-button:hover {
            background-color: #805ad5; /* P√∫rpura m√°s brillante */
        }
        .search-input, .form-input, .form-select {
            background-color: #4a5568;
            color: #e2e8f0;
            border-radius: 0.75rem;
            padding: 0.75rem 1rem;
            border: none;
        }
        .favorite-btn {
            color: #a0aec0; /* Gris claro */
            transition: color 0.2s ease-in-out;
        }
        .favorite-btn.active {
            color: #f6ad55; /* Naranja para favorito */
        }
        .modal {
            background-color: rgba(0, 0, 0, 0.7);
        }
        .modal-content {
            background-color: #2d3748;
            border-radius: 1rem;
        }
    </style>
</head>
<body class="min-h-screen flex flex-col items-center p-4">

    <!-- Header -->
    <header class="w-full max-w-4xl text-center mb-8">
        <h1 class="text-5xl font-extrabold gradient-bg text-transparent bg-clip-text pb-2">Atajos Pro ‚ö°Ô∏è</h1>
        <p class="text-xl text-gray-400 mt-2">¬°Domina Windows con estos trucos √©picos!</p>
        <p id="userIdDisplay" class="text-sm text-gray-500 mt-2">Cargando ID de usuario...</p>
    </header>

    <!-- Controls: Search, Filter, Add Shortcut -->
    <div class="w-full max-w-4xl mb-8 flex flex-col md:flex-row items-center justify-between space-y-4 md:space-y-0 md:space-x-4">
        <input type="text" id="searchInput" class="search-input flex-grow" placeholder="Busca atajos, acciones, etc..." onkeyup="filterShortcuts()">
        <select id="categoryFilter" class="search-input w-full md:w-auto mt-4 md:mt-0" onchange="filterShortcuts()">
            <option value="all">Todas las categor√≠as</option>
            <option value="general">Generales</option>
            <option value="windows_logo">Tecla Windows</option>
            <option value="command_prompt">S√≠mbolo del sistema</option>
            <option value="dialog_boxes">Cuadros de di√°logo</option>
            <option value="file_explorer">Explorador de archivos</option>
            <option value="virtual_desktops">Escritorios virtuales</option>
            <option value="taskbar">Barra de tareas</option>
            <option value="settings">Configuraci√≥n</option>
            <option value="user_added">A√±adidos por usuarios</option>
        </select>
        <button onclick="showAddShortcutModal()" class="px-6 py-3 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition duration-300 ease-in-out mt-4 md:mt-0">
            <i class="fas fa-plus mr-2"></i> Nuevo Atajo
        </button>
    </div>

    <!-- Shortcut Categories -->
    <div class="w-full max-w-4xl flex flex-wrap justify-center gap-3 mb-8">
        <button class="category-button active" data-category="all" onclick="selectCategory('all')">Todo</button>
        <button class="category-button" data-category="general" onclick="selectCategory('general')">Generales</button>
        <button class="category-button" data-category="windows_logo" onclick="selectCategory('windows_logo')">Tecla Windows</button>
        <button class="category-button" data-category="command_prompt" onclick="selectCategory('command_prompt')">S√≠mbolo del sistema</button>
        <button class="category-button" data-category="dialog_boxes" onclick="selectCategory('dialog_boxes')">Cuadros de di√°logo</button>
        <button class="category-button" data-category="file_explorer" onclick="selectCategory('file_explorer')">Explorador de archivos</button>
        <button class="category-button" data-category="virtual_desktops" onclick="selectCategory('virtual_desktops')">Escritorios virtuales</button>
        <button class="category-button" data-category="taskbar" onclick="selectCategory('taskbar')">Barra de tareas</button>
        <button class="category-button" data-category="settings" onclick="selectCategory('settings')">Configuraci√≥n</button>
        <button class="category-button" data-category="user_added" onclick="selectCategory('user_added')">A√±adidos por usuarios</button>
    </div>

    <!-- Shortcuts Grid -->
    <div id="shortcutsGrid" class="w-full max-w-5xl grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
        <!-- Shortcuts will be loaded here by JavaScript -->
        <p class="text-center text-xl col-span-full text-gray-400">Cargando atajos...</p>
    </div>

    <!-- Message Modal -->
    <div id="messageModal" class="modal fixed inset-0 flex items-center justify-center hidden z-50">
        <div class="modal-content p-6 max-w-sm w-full text-center">
            <p id="modalMessage" class="text-lg font-semibold mb-4"></p>
            <button class="px-4 py-2 bg-purple-600 rounded-md hover:bg-purple-700" onclick="hideModal()">Entendido</button>
        </div>
    </div>

    <!-- Add Shortcut Modal -->
    <div id="addShortcutModal" class="modal fixed inset-0 flex items-center justify-center hidden z-40">
        <div class="modal-content p-8 max-w-md w-full">
            <h2 class="text-2xl font-bold mb-6 text-center text-purple-300">¬°Agrega un Nuevo Atajo √âpico!</h2>
            <form id="addShortcutForm" onsubmit="event.preventDefault(); addShortcut()">
                <div class="mb-4">
                    <label for="newShortcutKey" class="block text-gray-300 text-sm font-bold mb-2">Tecla del Atajo:</label>
                    <input type="text" id="newShortcutKey" class="form-input w-full" placeholder="Ej: Ctrl + May√∫s + L" required>
                </div>
                <div class="mb-4">
                    <label for="newShortcutAction" class="block text-gray-300 text-sm font-bold mb-2">Acci√≥n:</label>
                    <textarea id="newShortcutAction" class="form-input w-full h-24 resize-y" placeholder="Ej: Bloquear la pantalla" required></textarea>
                </div>
                <div class="mb-6">
                    <label for="newShortcutCategory" class="block text-gray-300 text-sm font-bold mb-2">Categor√≠a:</label>
                    <select id="newShortcutCategory" class="form-select w-full" required>
                        <option value="general">Generales</option>
                        <option value="windows_logo">Tecla Windows</option>
                        <option value="command_prompt">S√≠mbolo del sistema</option>
                        <option value="dialog_boxes">Cuadros de di√°logo</option>
                        <option value="file_explorer">Explorador de archivos</option>
                        <option value="virtual_desktops">Escritorios virtuales</option>
                        <option value="taskbar">Barra de tareas</option>
                        <option value="settings">Configuraci√≥n</option>
                        <option value="user_added">A√±adidos por usuarios</option>
                    </select>
                </div>
                <div class="flex justify-end space-x-4">
                    <button type="button" onclick="hideAddShortcutModal()" class="px-5 py-2 bg-gray-600 rounded-md hover:bg-gray-700 transition duration-300 ease-in-out">Cancelar</button>
                    <button type="submit" class="px-5 py-2 bg-purple-600 rounded-md hover:bg-purple-700 transition duration-300 ease-in-out">Guardar Atajo</button>
                </div>
            </form>
        </div>
    </div>


    <script type="module">
        // Importar funciones de Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, query, where, getDocs, addDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Variables globales para Firebase y la aplicaci√≥n
        let app;
        let db;
        let auth;
        let userId;
        let appId; // Ahora appId es una variable global
        let allShortcuts = []; // Almacenar√° todos los atajos cargados desde Firestore
        let favorites = JSON.parse(localStorage.getItem('favoriteShortcuts')) || {}; // Favoritos locales

        // Obtener elementos del DOM
        const shortcutsGrid = document.getElementById('shortcutsGrid');
        const searchInput = document.getElementById('searchInput');
        const categoryFilter = document.getElementById('categoryFilter');
        const categoryButtons = document.querySelectorAll('.category-button');
        const messageModal = document.getElementById('messageModal');
        const modalMessage = document.getElementById('modalMessage');
        const addShortcutModal = document.getElementById('addShortcutModal');
        const addShortcutForm = document.getElementById('addShortcutForm');
        const newShortcutKey = document.getElementById('newShortcutKey');
        const newShortcutAction = document.getElementById('newShortcutAction'); // Asegurado que esto apunta a la acci√≥n
        const newShortcutCategory = document.getElementById('newShortcutCategory');
        const userIdDisplay = document.getElementById('userIdDisplay');

        /**
         * Muestra un modal con un mensaje.
         * @param {string} message - El mensaje a mostrar en el modal.
         */
        function showModal(message) {
            modalMessage.textContent = message;
            messageModal.classList.remove('hidden');
        }

        /**
         * Oculta el modal de mensajes.
         */
        function hideModal() {
            messageModal.classList.add('hidden');
        }

        /**
         * Muestra el modal para agregar un nuevo atajo.
         */
        window.showAddShortcutModal = function() {
            addShortcutModal.classList.remove('hidden');
            // Resetear el formulario cada vez que se abre
            addShortcutForm.reset();
        }

        /**
         * Oculta el modal para agregar un nuevo atajo.
         */
        window.hideAddShortcutModal = function() {
            addShortcutModal.classList.add('hidden');
        }

        /**
         * Renderiza los atajos de teclado en la cuadr√≠cula.
         * @param {Array} shortcutsToRender - El array de atajos a renderizar.
         */
        function renderShortcuts(shortcutsToRender) {
            shortcutsGrid.innerHTML = ''; // Limpiar cuadr√≠cula existente
            if (shortcutsToRender.length === 0) {
                shortcutsGrid.innerHTML = '<p class="text-center text-xl col-span-full text-gray-400">No se encontraron atajos para tu b√∫squeda.</p>';
                return;
            }

            shortcutsToRender.forEach(shortcut => {
                // Si el atajo no tiene un ID de Firestore, usamos la clave para el ID del DOM
                const shortcutId = shortcut.id || shortcut.key.replace(/\s+/g, '-').toLowerCase();
                const isFavorite = favorites[shortcut.key];
                const card = document.createElement('div');
                card.id = `shortcut-${shortcutId}`; // Asignar un ID √∫nico
                card.className = 'shortcut-card p-6 flex flex-col justify-between';
                card.innerHTML = `
                    <div>
                        <h3 class="text-xl font-bold mb-2 text-purple-300">${shortcut.key}</h3>
                        <p class="text-gray-300">${shortcut.action}</p>
                        ${shortcut.category === 'user_added' ? `<p class="text-sm text-gray-500 mt-2">Agregado por: ${shortcut.addedBy || 'Desconocido'}</p>` : ''}
                    </div>
                    <div class="flex justify-between items-center mt-4">
                        <span class="text-sm text-gray-400 capitalize">${shortcut.category.replace(/_/g, ' ')}</span>
                        <button class="favorite-btn text-2xl ${isFavorite ? 'active' : ''}" data-key="${shortcut.key}" onclick="toggleFavorite('${shortcut.key}', this)">
                            <i class="${isFavorite ? 'fas' : 'far'} fa-star"></i>
                        </button>
                    </div>
                `;
                shortcutsGrid.appendChild(card);
            });
        }

        /**
         * Filtra y busca atajos seg√∫n la entrada del usuario y la categor√≠a seleccionada.
         */
        window.filterShortcuts = function() {
            const searchTerm = searchInput.value.toLowerCase();
            const selectedCategory = categoryFilter.value;

            const filtered = allShortcuts.filter(shortcut => {
                const matchesSearch = shortcut.key.toLowerCase().includes(searchTerm) ||
                                      shortcut.action.toLowerCase().includes(searchTerm) ||
                                      (shortcut.tags && shortcut.tags.some(tag => tag.toLowerCase().includes(searchTerm))) ||
                                      (shortcut.addedBy && shortcut.addedBy.toLowerCase().includes(searchTerm)); // Permitir buscar por quien agreg√≥
                const matchesCategory = selectedCategory === 'all' || shortcut.category === selectedCategory;
                return matchesSearch && matchesCategory;
            });

            renderShortcuts(filtered);
        }

        /**
         * Cambia la categor√≠a de atajos mostrada y actualiza los botones de categor√≠a.
         * @param {string} category - La categor√≠a a seleccionar.
         */
        window.selectCategory = function(category) {
            // Actualizar el valor del selector de categor√≠a para sincronizarlo
            categoryFilter.value = category;

            categoryButtons.forEach(button => {
                if (button.dataset.category === category) {
                    button.classList.add('active');
                } else {
                    button.classList.remove('active');
                }
            });
            filterShortcuts(); // Volver a filtrar con la nueva categor√≠a
        }

        /**
         * Alterna el estado de favorito de un atajo y lo guarda en localStorage.
         * @param {string} key - La clave del atajo (su texto).
         * @param {HTMLElement} buttonElement - El elemento del bot√≥n de favorito.
         */
        window.toggleFavorite = function(key, buttonElement) {
            if (favorites[key]) {
                delete favorites[key];
                buttonElement.classList.remove('active');
                buttonElement.innerHTML = '<i class="far fa-star"></i>';
                showModal('¬°Atajo quitado de favoritos! üò¢');
            } else {
                favorites[key] = true;
                buttonElement.classList.add('active');
                buttonElement.innerHTML = '<i class="fas fa-star"></i>';
                showModal('¬°Atajo a√±adido a favoritos! üéâ');
            }
            localStorage.setItem('favoriteShortcuts', JSON.stringify(favorites));
        }

        /**
         * A√±ade un nuevo atajo a Firestore.
         */
        window.addShortcut = async function() {
            const key = newShortcutKey.value.trim();
            const action = newShortcutAction.value.trim(); // ¬°CORREGIDO! Ahora toma el valor del campo de acci√≥n
            const category = newShortcutCategory.value;

            if (!key || !action) {
                showModal('Por favor, completa todos los campos.');
                return;
            }

            // Asegurar que la base de datos est√© inicializada antes de hacer llamadas a Firestore
            if (!db) {
                console.error("Firestore DB no est√° inicializado.");
                showModal('¬°Oops! La base de datos no est√° lista. Intenta recargar la p√°gina.');
                return;
            }

            // Normalizar la clave para la verificaci√≥n de duplicados
            const normalizedKey = key.toLowerCase();

            try {
                // Verificar si el atajo ya existe
                const q = query(collection(db, `artifacts/${appId}/public/data/shortcuts`), where("normalizedKey", "==", normalizedKey));
                const querySnapshot = await getDocs(q);

                if (!querySnapshot.empty) {
                    showModal('¬°Este atajo ya existe! Intenta con otro. ü§î');
                    return;
                }

                // A√±adir el nuevo atajo a Firestore
                await addDoc(collection(db, `artifacts/${appId}/public/data/shortcuts`), {
                    key: key,
                    action: action,
                    category: category,
                    normalizedKey: normalizedKey, // Guardar la clave normalizada para b√∫squedas eficientes
                    addedBy: userId || 'anonymous', // Guardar el ID del usuario que lo a√±adi√≥
                    createdAt: new Date().toISOString() // Timestamp de creaci√≥n
                });

                hideAddShortcutModal();
                showModal('¬°Atajo agregado con √©xito! ‚ú®');
                addShortcutForm.reset(); // Limpiar el formulario
            } catch (e) {
                console.error("Error al a√±adir el atajo: ", e);
                showModal('¬°Oops! Hubo un error al guardar el atajo. Intenta de nuevo.');
            }
        }

        // --- Firebase Initialization and Data Loading ---
        document.addEventListener('DOMContentLoaded', async () => {
            try {
                // Obtener ID de la aplicaci√≥n y configuraci√≥n de Firebase
                appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id'; // Asignar a la variable global
                const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');

                // Inicializar Firebase
                app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);

                // Autenticar al usuario
                if (typeof __initial_auth_token !== 'undefined') {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }

                // Establecer el ID de usuario una vez que la autenticaci√≥n est√© lista
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        userIdDisplay.textContent = `Tu ID de usuario: ${userId}`;
                        // Cargar ataj